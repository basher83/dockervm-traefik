services:
  traefik:
    container_name: traefik
    image: traefik:3.3
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    depends_on:
      - socket-proxy
    networks:
      traefik-proxy:
      socket-proxy:
    command:
      # Global
      - --global.checkNewVersion=true
      - --global.sendAnonymousUsage=false
      
      # Entry Points
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.traefik.address=:8080
      
      # HTTP to HTTPS redirect
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      
      # API and Dashboard
      - --api=true
      - --api.dashboard=true
      - --api.insecure=true
      
      # Logging
      - --log=true
      - --log.filePath=/logs/traefik.log
      - --log.level=INFO
      - --log.format=json
      - --accessLog=true
      - --accessLog.format=json
      - --accessLog.fields.defaultMode=keep
      - --accessLog.fields.headers.defaultMode=keep
      - --accessLog.filePath=/logs/access.log
      - --accessLog.bufferingSize=100
      - --accessLog.filters.statusCodes=204-299,400-499,500-599      
      # Metrics (optional)
      - --metrics.prometheus=${METRICS_ENABLED:-false}
      - --metrics.prometheus.addentrypointslabels=true
      - --metrics.prometheus.addserviceslabels=true
      - --entrypoints.metrics.address=:8083
      
      # Docker Provider (via Socket Proxy)
      - --providers.docker=true
      - --providers.docker.endpoint=tcp://socket-proxy:2375
      - --providers.docker.exposedByDefault=false
      - --providers.docker.network=traefik-proxy
      
      # File Provider for dynamic config
      - --providers.file.directory=/rules
      - --providers.file.watch=true
      
      # TLS Configuration
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.options=tls-opts@file
      
      # Certificate Resolver (HTTP Challenge for now)
      - --certificatesresolvers.letsencrypt.acme.storage=/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.letsencrypt.acme.email=admin@lab.spaceships.work
      
      # Default cert resolver
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      
    ports:
      - '80:80'
      - '443:443'
      - '8080:8080'
      # Uncomment for metrics endpoint
      # - '${METRICS_PORT:-8083}:8083'
    deploy:
      resources:
        limits:
          cpus: '${TRAEFIK_CPU_LIMIT:-1}'
          memory: ${TRAEFIK_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '0.25'
          memory: 128M
    volumes:
      - ./appdata/traefik/rules:/rules:ro
      - ./appdata/traefik/acme/acme.json:/acme.json
      - ./logs/traefik:/logs
    environment:
      - TZ=UTC
      # Uncomment and configure for Cloudflare DNS challenge
      # - CF_DNS_API_TOKEN_FILE=/run/secrets/cf_dns_api_token
    # Uncomment for production secrets
    # secrets:
    #   - cf_dns_api_token
    #   - basic_auth_credentials
    labels:
      - 'traefik.enable=true'
      # Dashboard router
      - 'traefik.http.routers.traefik-dashboard.rule=Host(`traefik.lab.spaceships.work`)'
      - 'traefik.http.routers.traefik-dashboard.entrypoints=websecure'
      - 'traefik.http.routers.traefik-dashboard.service=api@internal'
      - 'traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt'
      # Uncomment for basic auth protection
      # - 'traefik.http.routers.traefik-dashboard.middlewares=basic-auth@file'

  # Log rotation for Traefik logs
  logrotate:
    image: alpine:3.22
    container_name: traefik-logrotate
    restart: unless-stopped
    volumes:
      - ./logs/traefik:/logs
      - ./scripts/logrotate.conf:/scripts/logrotate.conf:ro
    command: >
      sh -c "
        apk add --no-cache logrotate &&
        echo '0 2 * * * /usr/sbin/logrotate /scripts/logrotate.conf' | crontab - &&
        crond -f -d 0
      "
    depends_on:
      - traefik